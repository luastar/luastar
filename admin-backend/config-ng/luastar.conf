# openresty 配置文件

## 日志配置
access_log  '/Users/zhuminghua/Documents/logs/luastar/access.log' main;
error_log   '/Users/zhuminghua/Documents/logs/luastar/error.log'  info;

## 设置 Lua 包路径(';;'为默认路径)
lua_package_path '/Users/zhuminghua/Documents/code-zmh/luastar/core/?.lua;;';

## 初始化配置
init_by_lua_file '/Users/zhuminghua/Documents/code-zmh/luastar/core/init_by_lua.lua';
init_worker_by_lua_file '/Users/zhuminghua/Documents/code-zmh/luastar/core/init_worker_by_lua.lua';

## 域名解析
resolver 114.114.114.114 8.8.8.8 valid=3600s;

## 避免获取 request body 时可能缓存到临时文件
# client_max_body_size 100m;
# client_body_buffer_size 100m;

## Luastar 缓存
lua_shared_dict dict_ls_routes 128m;
lua_shared_dict dict_ls_stream 64m;

## 代理服务
upstream backend {
  server 0.0.0.1;
  balancer_by_lua_file '/Users/zhuminghua/Documents/code-zmh/luastar/core/balancer_by_lua.lua';
  keepalive 20;
}

server {
  listen 8001;
  server_name localhost;

  ## 加载最新代码，生产环境一定要置为on（默认值）
  lua_code_cache off;

  ## Luastar 路径
  set $LUASTAR_PATH '/Users/zhuminghua/Documents/code-zmh/luastar';
  ## 应用名称、项目路径、配置文件路径、源码路径
  set $APP_NAME 'luastar_admin';
  set $APP_PATH '${LUASTAR_PATH}/admin-backend';
  set $APP_CONFIG '/config/app.lua';

  ## 后端接口路由
  location ^~/api/ {
    content_by_lua_file '${LUASTAR_PATH}/core/content_by_lua.lua';
  }

  ## 后端代理转发路由
  location ^~/proxy/ {
    proxy_pass  http://backend/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  ## 前端路由
  location / {
    root   '${APP_PATH}/admin-frontend/dist';
    index  index.html index.htm;
  }

}

server {
    listen 8002;
    location = /fake {
        # echo "this is the fake backend peer...";
      default_type 'text/plain';
      content_by_lua_block {
        ngx.say('this is the fake backend peer...')
      }
    }
}